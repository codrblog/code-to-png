<script src="https://pagecdn.io/lib/ace/1.4.7/ace.js" crossorigin="anonymous"
  integrity="sha256-C7DTYRJLG+B/VEzHGeoPMw699nsTQYPAXHKXZb+q04E="></script>
<script src="https://pagecdn.io/lib/html2canvas/0.4.1/html2canvas.min.js" crossorigin="anonymous"></script>

<script>
  let socket;
  let editor;

  async function toHash(text) {
    const buffer = new TextEncoder('utf-8').encode(text);
    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => ('00' + b.toString(16)).slice(-2)).join('');
  }

  function reconnnect() {
    socket = new WebSocket('ws://localhost:5000/');
    socket.onclose = () => setTimeout(reconnnect, 3000);
    socket.onmessage = async function (event) {
      const code = event.data;
      const hash = await toHash(code);
      editor.getSession().setValue(code);
      setTimeout(async () => {
        const image = await render(code);
        socket.send(JSON.stringify({ hash, image }));
      }, 100);
    }
  }

  async function render() {
    const canvas = await new Promise((resolve) => html2canvas(document.getElementById('code'), { scale: 2, onrendered: resolve }));
    const image = canvas.toDataURL();
    return image.split('base64,')[1];
  }

  function startEditor() {
    editor = ace.edit('editor', {
      theme: 'ace/theme/monokai',
      mode: 'ace/mode/typescript',
      maxLines: 500,
      minLines: 2,
      fontSize: 13,
      wrap: true,
      useWorker: false,
      autoScrollEditorIntoView: true
    });

    editor.setHighlightActiveLine(false);
    editor.setHighlightSelectedWord(false);
    editor.setHighlightGutterLine(false);
    editor.setShowPrintMargin(false);
    editor.setOption('displayIndentGuides', false);
  }

  document.addEventListener('DOMContentLoaded', () => {
    startEditor();
    reconnnect();
  });
</script>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  #editor {
    position: relative;
    width: 700px;
    height: 400px;
    left: calc(50% - 700px);
    top: 50px;
  }
</style>
<div id="code">
  <div id="editor"></div>
</div>
